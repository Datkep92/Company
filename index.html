<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Upload HTML Invoice lên GitHub</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<style>
body{font-family:sans-serif;margin:20px;}
input, button{margin:5px 0;padding:6px 12px;}
textarea{width:100%;height:300px;margin-top:10px;}
</style>
</head>
<body>
<h1>Upload HTML từ ZIP lên GitHub (gom 1 folder)</h1>

<label>GitHub Token:</label><br>
<input type="text" id="githubToken" placeholder="Nhập token GitHub" style="width:100%;"><br>

<label>Chọn nhiều ZIP:</label><br>
<input type="file" id="zipFiles" multiple accept=".zip"><br>

<button id="uploadBtn">Upload</button>

<h3>Log:</h3>
<textarea id="log" readonly></textarea>

<script>
const repoOwner = "Datkep92";
const repoName = "Company";

function log(msg){ 
    const ta=document.getElementById("log"); 
    ta.value+=msg+"\n"; 
    ta.scrollTop=ta.scrollHeight; 
}

async function uploadFile(token, path, content){
    const apiUrl = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${path}`;
    const base64Content = btoa(unescape(encodeURIComponent(content)));
    const body = { message:`Upload ${path}`, content: base64Content };
    const res = await fetch(apiUrl,{
        method:"PUT",
        headers:{ "Authorization":`token ${token}`, "Content-Type":"application/json"},
        body: JSON.stringify(body)
    });
    const data = await res.json();
    if(data.content && data.content.html_url){
        log(`✅ Upload thành công: ${data.content.html_url}`);
    }else{
        log(`❌ Lỗi upload ${path}: ${JSON.stringify(data)}`);
    }
}

document.getElementById("uploadBtn").addEventListener("click", async ()=>{
    const token = document.getElementById("githubToken").value.trim();
    if(!token) return alert("Nhập token GitHub!");
    const files = document.getElementById("zipFiles").files;
    if(!files.length) return alert("Chưa chọn file ZIP");

    let counter=1;
    const today=new Date();
    const yyyymmdd = today.getFullYear().toString()+
                      String(today.getMonth()+1).padStart(2,'0')+
                      String(today.getDate()).padStart(2,'0');

    for(const file of files){
        log(`⏳ Đang xử lý: ${file.name}`);
        try{
            const arrayBuffer = await file.arrayBuffer();
            const zip = await JSZip.loadAsync(arrayBuffer);
            const htmlFiles = Object.keys(zip.files).filter(name=>name.toLowerCase().endsWith(".html"));

            if(htmlFiles.length===0){
                log(`⚠ Bỏ qua ${file.name}: không có HTML`);
                continue;
            }

            for(const htmlName of htmlFiles){
                const htmlContent = await zip.file(htmlName).async("text");
                const fileName = `${yyyymmdd}-${String(counter).padStart(2,'0')}.html`;
                counter++;
                await uploadFile(token, `invoice/${fileName}`, htmlContent);
            }

        }catch(err){
            log(`❌ Lỗi xử lý ${file.name}: ${err}`);
        }
    }
    log("✅ Hoàn tất upload tất cả HTML.");
});
</script>
</body>
</html>