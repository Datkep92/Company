<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Upload HTML từ ZIP lên GitHub</title>
<script src="https://unpkg.com/fzip@latest/dist/fzip.min.js"></script>
<style>
body{font-family:sans-serif;margin:20px;}
input, button{margin:5px 0;padding:6px 12px;}
textarea{width:100%;height:300px;margin-top:10px;}
</style>
</head>
<body>
<h1>Upload HTML từ ZIP lên GitHub</h1>

<label>Nhập GitHub Personal Access Token:</label><br>
<input type="text" id="githubToken" placeholder="Token GitHub" style="width:100%;"><br>

<label>Chọn nhiều file ZIP:</label><br>
<input type="file" id="zipFiles" multiple accept=".zip"><br>

<button id="uploadBtn">Upload HTML lên GitHub</button>

<h3>Log:</h3>
<textarea id="log" readonly></textarea>

<script>
const repoOwner = "Datkep92";
const repoName = "Company";

function log(msg) {
    const ta = document.getElementById("log");
    ta.value += msg + "\n";
    ta.scrollTop = ta.scrollHeight;
}

async function uploadHTML(token, filename, content, folderName) {
    const path = `${folderName}/invoice/${filename}`;
    const apiUrl = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${path}`;
    const base64Content = btoa(unescape(encodeURIComponent(content)));

    const body = {
        message: `Upload ${filename} vào ${folderName}/invoice`,
        content: base64Content
    };

    try {
        const res = await fetch(apiUrl, {
            method: "PUT",
            headers: {
                "Authorization": `token ${token}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify(body)
        });
        const data = await res.json();
        if (data.content && data.content.html_url) {
            log(`✅ Upload thành công: ${data.content.html_url}`);
        } else {
            log(`❌ Lỗi upload ${filename}: ${JSON.stringify(data)}`);
        }
    } catch (err) {
        log(`❌ Lỗi kết nối GitHub: ${err}`);
    }
}

document.getElementById("uploadBtn").addEventListener("click", async () => {
    const token = document.getElementById("githubToken").value.trim();
    if (!token) return alert("Vui lòng nhập GitHub Token!");

    const files = document.getElementById("zipFiles").files;
    if (!files.length) return alert("Chưa chọn file ZIP");

    let counter = 1;
    const today = new Date();
    const yyyymmdd = today.getFullYear().toString() +
                      String(today.getMonth()+1).padStart(2,"0") +
                      String(today.getDate()).padStart(2,"0");

    for (const file of files) {
        log(`⏳ Đang xử lý: ${file.name}`);

        try {
            const arrayBuffer = await file.arrayBuffer();
            const zip = fzip.readZip(arrayBuffer);

            // Tìm HTML đầu tiên
            let htmlFile = null;
            for (let f of zip.files) {
                if (f.name.toLowerCase().endsWith(".html")) {
                    htmlFile = f;
                    break;
                }
            }

            if (!htmlFile) {
                log(`⚠ Bỏ qua ${file.name}: không có file HTML`);
                continue;
            }

            const htmlContent = new TextDecoder().decode(htmlFile.data);
            const folderName = `${yyyymmdd}-ABC${String(counter).padStart(2,"0")}`;
            counter++;

            await uploadHTML(token, htmlFile.name, htmlContent, folderName);
        } catch (err) {
            log(`❌ Lỗi xử lý ZIP ${file.name}: ${err}`);
        }
    }

    log("✅ Hoàn tất upload tất cả ZIP có HTML.");
});
</script>
</body>
</html>